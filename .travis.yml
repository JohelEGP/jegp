language: cpp
os: linux
dist: bionic

env:
  global:
  - PATH=/tmp/bin:/tmp/node_modules/.bin:$PATH
  - CXXFLAGS="-Wpedantic -Wall -Wextra"
  - JEGP_OPTIONS=-DJEGP_TEST=ON
  - NODE_PATH=/tmp/node_modules:/tmp/node_modules/mathjax-node-cli/node_modules

jobs:
  include:
  - addons:
      apt:
        packages:
        - latexmk
        - texlive-latex-recommended
        - texlive-latex-extra
        - texlive-fonts-recommended
        - texlive-generic-recommended
        - lmodern
    compiler: clang
    env: MATRIX_EVAL="JEGP_DOC=1"
  - os: osx
    compiler: clang
  - compiler: gcc
    addons:
      apt:
        packages:
        - g++-8
    env: MATRIX_EVAL="CXX=g++-8"
  - compiler: gcc
    addons:
      apt:
        sources:
        - sourceline: 'ppa:ubuntu-toolchain-r/test'
        packages:
        - g++-9
    env: MATRIX_EVAL="CXX=g++-9"
  - compiler: clang
  - compiler: clang
    addons:
      apt:
        sources:
        - sourceline: 'deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-8 main'
          key_url: https://apt.llvm.org/llvm-snapshot.gpg.key
        packages:
        - clang-8
        - libc++-8-dev
        - libc++abi-8-dev
  - compiler: clang
    addons:
      apt:
        sources:
        - sourceline: 'deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-9 main'
          key_url: https://apt.llvm.org/llvm-snapshot.gpg.key
        packages:
        - clang-9
        - libc++-9-dev
        - libc++abi-9-dev

before_script:
- eval "${MATRIX_EVAL}"
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then travis/install_cmake.sh 3.15.4; fi
- |
  if [ $TRAVIS_COMPILER == clang ]; then
    CXXFLAGS="$CXXFLAGS -stdlib=libc++"
    LDFLAGS=-lc++abi
  fi
- |
  if [ -n "$JEGP_DOC" ]; then
    JEGP_OPTIONS="$JEGP_OPTIONS -DJEGP_DOC_PDF=ON -DJEGP_DOC_HTML=Bare"
    travis/meet_doc_prereq.sh
  fi

script:
- cmake -E make_directory build
- cmake -E chdir build cmake .. $JEGP_OPTIONS
- cmake --build build -j 2

cache:
  directories: $HOME/.stack

before_deploy: travis/postprocess_doc.sh

deploy:
  provider: pages:git
  edge: true
  allow_empty_commit: false
  local_dir: doc/jegp/
  on:
    condition: -n $JEGP_DOC

notifications:
  email: false
